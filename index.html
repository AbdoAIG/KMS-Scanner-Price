<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 10px; background-color: #f0f2f5; margin: 0; }
  
  /* Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª */
  .container { max-width: 600px; margin: 0 auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
  
  /* Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
  #reader { width: 100%; border-radius: 10px; overflow: hidden; margin-bottom: 15px; border: 2px solid #ddd; }
  
  /* Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ */
  h2 { color: #333; margin-bottom: 10px; font-size: 20px; }
  .result-box { display: none; text-align: center; padding: 20px 0; }
  .product-img { width: 100%; max-width: 200px; height: 200px; object-fit: contain; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
  .price { font-size: 32px; color: #28a745; font-weight: bold; margin: 10px 0; }
  .name { font-size: 22px; font-weight: bold; color: #333; margin-bottom: 5px; }
  
  /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
  .btn { display: block; width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; text-decoration: none; box-sizing: border-box; }
  .btn-primary { background-color: #007bff; color: white; }
  .btn-warning { background-color: #ffc107; color: #333; }
  .btn-secondary { background-color: #6c757d; color: white; }

  /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
  .status-msg { margin: 10px 0; font-size: 14px; padding: 8px; border-radius: 5px; display: none; }
  .loading { background-color: #e2e6ea; color: #333; }
  .offline { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
  .error { background-color: #f8d7da; color: #721c24; }

</style>
</head>
<body>

<div class="container">
  
  <div id="scan-screen">
    <h2>Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    
    <div id="status" class="status-msg loading">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...</div>

    <div id="reader"></div>

    <p style="font-size:12px; color:#666;">ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</p>
    
    <a id="add-btn" href="#" target="_blank" class="btn btn-warning">
      + Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ (Ù„Ù„Ø²Ù…Ù„Ø§Ø¡)
    </a>
  </div>

  <div id="result-screen" class="result-box">
    <img id="p_img" src="" class="product-img" onerror="this.style.display='none'">
    <div id="p_name" class="name">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</div>
    <div id="p_price" class="price">0.00</div>
    
    <hr style="border:0; border-top:1px solid #eee; margin: 15px 0;">
    
    <button class="btn btn-primary" onclick="resetScanner()">Ù…Ø³Ø­ Ù…Ù†ØªØ¬ Ø¢Ø®Ø±</button>
  </div>

</div>

<script>
    // ============================================================
    // ğŸ”´ğŸ”´ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (ØºÙŠØ± Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø±ÙˆØ§Ø¨Ø·Ùƒ) ğŸ”´ğŸ”´
    // ============================================================
    
    // 1. Ø±Ø§Ø¨Ø· Ù…Ù„Ù Ø§Ù„Ù€ CSV Ù…Ù† Google Sheets (File > Share > Publish to web > CSV)
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKotb6frhhZzBOkKyvUu0V1x06UkENSEkdtSn52yfc7OG030tDMxwjjjEX8tV1UGgpNzMTuObGRur3/pub?output=csv";

    // 2. Ø±Ø§Ø¨Ø· Google Form (Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª)
    const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfT5WLBAE4dTq-uprfqbVnX1K8HWrOs8AlyGH60IdEkBee2Kg/viewform?usp=header";

    // ============================================================

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    var productsDB = {}; 
    var html5QrcodeScanner;
    const statusDiv = document.getElementById('status');

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    document.getElementById('add-btn').href = GOOGLE_FORM_URL;

    // --- 1. Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø°ÙƒÙŠØ©) ---
    async function fetchProducts() {
      showStatus("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...", "loading");
      
      try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
        const response = await fetch(SHEET_CSV_URL, { cache: "no-store" });
        if (!response.ok) throw new Error("Network error");
        
        const data = await response.text();
        
        // Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§ØªØµØ§Ù„: Ù†Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        localStorage.setItem('offline_products_csv', data);
        
        parseCSV(data);
        showStatus("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« (Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)", "loading"); // Ø±Ø³Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ©
        setTimeout(() => { statusDiv.style.display = 'none'; }, 2000);

      } catch (error) {
        // ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        console.log("Offline mode activated");
        const cachedData = localStorage.getItem('offline_products_csv');
        
        if (cachedData) {
          parseCSV(cachedData);
          showStatus("âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† (Ø£Ø³Ø¹Ø§Ø± Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«)", "offline");
        } else {
          showStatus("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©!", "error");
          alert("ØªÙ†Ø¨ÙŠÙ‡: ÙŠØ¬Ø¨ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ„Ùˆ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±.");
        }
      }
    }

    // --- 2. ØªØ­ÙˆÙŠÙ„ CSV Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ---
    function parseCSV(csvText) {
      const rows = csvText.split('\n');
      productsDB = {}; // ØªØµÙÙŠØ± Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
      
      // Ù†Ø¨Ø¯Ø£ Ù…Ù† 1 Ù„ØªØ®Ø·ÙŠ Ø³Ø·Ø± Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
      for (let i = 1; i < rows.length; i++) {
        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ÙÙˆØ§ØµÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†ØµÙˆØµ Ø¥Ù† ÙˆØ¬Ø¯Øª (ØªÙ†Ø³ÙŠÙ‚ CSV Ø¨Ø³ÙŠØ·)
        const row = rows[i].split(','); 
        
        if (row.length >= 3) {
          // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªÙ†ØµÙŠØµ ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
          const code = clean(row[0]); 
          const name = clean(row[1]);
          const price = clean(row[2]);
          const img = row[3] ? clean(row[3]) : "";
          
          if(code) {
            productsDB[code] = { name: name, price: price, img: img };
          }
        }
      }
      console.log("Loaded Products:", Object.keys(productsDB).length);
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†ØµÙˆØµ
    function clean(text) {
        return text ? text.replace(/"/g, '').trim() : "";
    }

    // --- 3. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ ---
    function onScanSuccess(decodedText, decodedResult) {
      // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙˆØ±Ø§Ù‹ Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø·Ø§Ù‚Ø©
      if(html5QrcodeScanner) {
          html5QrcodeScanner.clear(); 
      }

      if (productsDB[decodedText]) {
        // Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯
        showResultScreen(productsDB[decodedText]);
      } else {
        // Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
        let userChoice = confirm("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø³Ø¬Ù„!\nØ§Ù„Ø±Ù‚Ù…: " + decodedText + "\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡ Ø§Ù„Ø¢Ù†ØŸ");
        if(userChoice) {
            window.open(GOOGLE_FORM_URL, '_blank');
            resetScanner(); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        } else {
            resetScanner(); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        }
      }
    }

    function showResultScreen(product) {
      document.getElementById('scan-screen').style.display = 'none';
      document.getElementById('result-screen').style.display = 'block';
      
      document.getElementById('p_name').innerText = product.name;
      document.getElementById('p_price').innerText = product.price;
      
      const imgElem = document.getElementById('p_img');
      if(product.img && product.img.startsWith('http')) {
        imgElem.src = product.img;
        imgElem.style.display = 'inline-block';
      } else {
        imgElem.style.display = 'none';
      }
    }

    function resetScanner() {
      document.getElementById('result-screen').style.display = 'none';
      document.getElementById('scan-screen').style.display = 'block';
      startCamera();
    }

    function startCamera() {
      html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
      html5QrcodeScanner.render(onScanSuccess);
    }

    function showStatus(text, type) {
        statusDiv.innerText = text;
        statusDiv.className = "status-msg " + type;
        statusDiv.style.display = 'block';
    }

    // --- 4. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ ---
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    fetchProducts().then(() => {
      startCamera();
    });

</script>

</body>
</html>