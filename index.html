<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø±ÙƒØ© (V65 Glass)</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');

  :root {
      --primary-color: #0062cc; 
      --secondary-color: #007bff; 
      --bg-body: #f0f2f5; 
      --card-bg: #ffffff; 
      --text-dark: #2d3436; 
      --text-light: #636e72;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --scanner-color: #ffffff;
  }

  body { 
      font-family: 'Tajawal', sans-serif; 
      text-align: center; 
      padding: 0; 
      background-color: var(--bg-body); 
      margin: 0; 
      color: var(--text-dark); 
      user-select: none; 
      -webkit-tap-highlight-color: transparent;
      padding-top: 40px;
  }
  
  .container { 
      max-width: 600px; margin: 10px auto; 
      background: var(--card-bg); padding: 20px; 
      border-radius: 25px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
      position: relative; min-height: 85vh; 
      padding-bottom: 80px; 
      display: flex; flex-direction: column;
  }
  
  .app-logo { max-width: 130px; max-height: 80px; display: block; margin: 0 auto 10px auto; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }

  .connection-badge { display: inline-block; padding: 6px 18px; border-radius: 20px; font-size: 13px; font-weight: bold; color: white; margin-bottom: 15px; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  .conn-online { background: linear-gradient(45deg, #28a745, #218838); }
  .conn-offline { background: linear-gradient(45deg, #dc3545, #c82333); }
  .conn-checking { background: linear-gradient(45deg, #ffc107, #e0a800); color: #333; }

  .btn { display: block; width: 100%; padding: 16px; margin-top: 15px; border: none; border-radius: 15px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: transform 0.1s, box-shadow 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); font-family: 'Tajawal', sans-serif; }
  .btn:active { transform: scale(0.97); }
  .btn-primary { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); }
  .btn-warning { background: linear-gradient(45deg, #ffc107, #ff9800); color: #333; }
  .btn-edit { background: linear-gradient(45deg, #17a2b8, #138496); }
  .refresh-btn { background: white; border: 1px solid var(--secondary-color); color: var(--primary-color); padding: 8px 20px; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; margin-bottom: 15px; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

  /* ğŸ’ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (ØªØµÙ…ÙŠÙ… Ø§Ù„Ø²Ø¬Ø§Ø¬) ğŸ’ */
  .menu-btn { position: absolute; top: 45px; right: 25px; font-size: 35px; cursor: pointer; background: none; border: none; color: var(--primary-color); z-index: 5000; filter: drop-shadow(0 2px 2px rgba(255,255,255,0.8)); }

  .sidenav {
      height: 100%;
      width: 0;
      position: fixed;
      z-index: 6000;
      top: 0;
      right: 0;
      /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© */
      background: rgba(255, 255, 255, 0.9); 
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      overflow-x: hidden;
      transition: 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      padding-top: 20px; /* Ù…Ø³Ø§ÙØ© Ù„Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */
      text-align: right;
      box-shadow: -10px 0 30px rgba(0,0,0,0.15);
      border-left: 1px solid rgba(255,255,255,0.6);
  }

  /* ØªÙ†Ø³ÙŠÙ‚ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
  .sidenav a {
      padding: 15px 25px;
      text-decoration: none;
      font-size: 17px;
      color: var(--primary-color); /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø£Ø²Ø±Ù‚ */
      display: block;
      transition: 0.3s;
      font-weight: 700;
      border-radius: 15px 0 0 15px;
      margin-left: 20px;
      margin-bottom: 5px;
  }

  .sidenav a:hover {
      background: var(--primary-color);
      color: white;
      transform: translateX(-8px);
      box-shadow: 0 5px 15px rgba(0,98,204,0.2);
  }

  .sidenav .closebtn {
      position: absolute;
      top: 15px;
      right: 25px;
      font-size: 40px;
      color: #333;
      margin: 0;
      padding: 0;
      background: none;
      box-shadow: none;
  }
  .sidenav .closebtn:hover { background: none; color: var(--danger-color); transform: none; box-shadow: none; }

  /* ØªÙ†Ø³ÙŠÙ‚ Ø±Ø£Ø³ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
  .sidenav-header {
      text-align: center;
      margin-top: 40px;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  .sidenav-header img {
      width: 90px; height: 90px;
      object-fit: contain;
      border-radius: 50%;
      background: white;
      padding: 5px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 10px;
  }
  
  .search-wrapper { position: relative; margin-bottom: 20px; }
  .search-input { width: 100%; padding: 15px; background: #f8f9fa; border: 2px solid transparent; border-radius: 15px; font-size: 16px; font-family: 'Tajawal', sans-serif; box-shadow: 0 4px 10px rgba(0,0,0,0.03); transition: 0.3s; box-sizing: border-box; outline: none; }
  .search-input:focus { background: white; border-color: var(--secondary-color); box-shadow: 0 4px 15px rgba(0,123,255,0.2); }
  .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 0 0 15px 15px; z-index: 1000; max-height: 250px; overflow-y: auto; display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
  .suggestion-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; text-align: right; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: var(--text-dark); font-weight: 500; }
  .suggestion-thumb { width: 40px; height: 40px; object-fit: contain; border-radius: 8px; border: 1px solid #eee; background: #fff; margin-left: 10px; }
  .prod-info-flex { display: flex; align-items: center; }

  .sub-cats-container { display: flex; overflow-x: auto; white-space: nowrap; padding: 10px 5px; gap: 10px; margin-bottom: 15px; scrollbar-width: none; }
  .sub-cat-btn { background: white; color: var(--text-light); border: 1px solid #eee; padding: 8px 18px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-family: 'Tajawal', sans-serif; }
  .sub-cat-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 4px 10px rgba(0,98,204,0.4); transform: scale(1.05); }

  /* Ø§Ù„Ù…Ø§Ø³Ø­ */
  .scanner-wrapper { position: relative; width: 100%; height: 350px; margin-bottom: 10px; border-radius: 20px; overflow: hidden; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 3px solid var(--secondary-color); }
  #reader { width: 100%; height: 100%; object-fit: cover; }
  .laser-beam { position: absolute; width: 100%; height: 3px; background: #ff0000; box-shadow: 0 0 20px #ff0000; top: 0; left: 0; z-index: 10; animation: scan-anim 1.5s infinite ease-in-out; pointer-events: none; }
  @keyframes scan-anim { 0% { top: 10%; opacity: 0; } 50% { opacity: 1; } 100% { top: 90%; opacity: 0; } }
  .scan-overlay { position: absolute; top: 20px; left: 20px; right: 20px; bottom: 20px; border-radius: 15px; pointer-events: none; box-shadow: inset 0 0 40px rgba(255, 255, 255, 0.1); }
  .scan-overlay::before, .scan-overlay::after { content: ''; position: absolute; width: 40px; height: 40px; border-color: white; border-style: solid; border-width: 0; filter: drop-shadow(0 0 5px white); }
  .scan-overlay::before { top: 0; left: 0; border-top-width: 4px; border-left-width: 4px; border-radius: 12px 0 0 0; }
  .scan-overlay::after { top: 0; right: 0; border-top-width: 4px; border-right-width: 4px; border-radius: 0 12px 0 0; }
  .scan-corners-bottom { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
  .scan-corners-bottom::before, .scan-corners-bottom::after { content: ''; position: absolute; width: 40px; height: 40px; border-color: white; border-style: solid; border-width: 0; filter: drop-shadow(0 0 5px white); }
  .scan-corners-bottom::before { bottom: 0; left: 0; border-bottom-width: 4px; border-left-width: 4px; border-radius: 0 0 0 12px; }
  .scan-corners-bottom::after { bottom: 0; right: 0; border-bottom-width: 4px; border-right-width: 4px; border-radius: 0 0 12px 0; }
  
  .fix-camera-btn { background: #dc3545; color: white; border: none; padding: 12px 25px; border-radius: 30px; font-size: 14px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4); animation: pulse 2s infinite; }
  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

  .zoom-controls { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; padding: 0 10px; }
  .zoom-label { font-size: 14px; color: var(--text-light); font-weight: bold; }
  input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; background: #e0e0e0; border-radius: 5px; outline: none; }
  input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; border-radius: 50%; background: var(--secondary-color); cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }

  #list-screen, .result-box { display: none; text-align: right; }
  .result-box { text-align: center; background: #fff; padding: 20px; border-radius: 15px; border: 1px solid #dae1e7; }
  .product-img { width: auto; height: 120px; max-width: 100%; object-fit: contain; border-radius: 10px; margin: 0 auto 15px; border: 1px solid #eee; background: white; cursor: pointer; display: block; }
  .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #eee; }
  .detail-label { color: var(--text-light); font-weight: bold; font-size: 14px; margin-left: 10px; }
  .detail-value { color: var(--text-dark); font-weight: 800; font-size: 16px; }
  .barcode-style { font-family: 'Courier New', monospace; background: #f0f0f0; padding: 4px 10px; border-radius: 6px; letter-spacing: 1px; color: #555; }
  .prices-table { width: 100%; margin-top: 20px; border-collapse: separate; border-spacing: 0; border-radius: 12px; overflow: hidden; border: 1px solid #eee; }
  .prices-table th { background: var(--primary-color); color: white; padding: 12px; font-size: 14px; }
  .prices-table td { padding: 12px; border-bottom: 1px solid #f5f5f5; font-weight: bold; color: var(--text-dark); text-align: center; }
  .prices-table tr:last-child td { border-bottom: none; }
  .prices-table td.price-val { color: #27ae60; font-size: 18px; }

  #back-fab { position: fixed; bottom: 25px; left: 25px; width: 60px; height: 60px; background-color: var(--secondary-color); color: white; border-radius: 50%; border: none; box-shadow: 0 5px 20px rgba(0,123,255,0.4); font-size: 28px; cursor: pointer; z-index: 2000; display: none; align-items: center; justify-content: center; transition: transform 0.2s; }
  #back-fab:active { transform: scale(0.9); }

  .modal { display: none; position: fixed; z-index: 5000; padding-top: 50px; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
  .modal-content { margin: auto; display: block; width: 90%; max-width: 700px; border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.5); }
  .close-zoom { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; }
  .form-modal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background-color: white; }
  .form-iframe { width: 100%; height: 100%; border: none; }
  .close-form-btn { position: absolute; top: 15px; left: 15px; background: #dc3545; color: white; border: none; padding: 10px 25px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; z-index: 4001; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3); }

  .action-buttons { display: flex; gap: 15px; margin-top: 25px; }
  .action-buttons button { flex: 1; margin-top: 0; }
  .status-msg { margin: 10px 0; font-size: 14px; padding: 10px; border-radius: 8px; display: none; font-weight: bold; }
  .loading { background-color: #e2f0fb; color: var(--primary-color); }
  .designer-footer { margin-top: auto; padding-top: 30px; border-top: 1px solid #eee; font-size: 12px; color: #999; text-align: center; font-weight: bold; opacity: 0.8; }
</style>
</head>
<body>

<div id="imageModal" class="modal" onclick="closeImageModal()"><span class="close-zoom">&times;</span><img class="modal-content" id="img01"></div>
<div id="formModal" class="form-modal"><button class="close-form-btn" onclick="closeFormModal()">âœ– Ø¥ØºÙ„Ø§Ù‚ ÙˆØ¹ÙˆØ¯Ø©</button><iframe id="googleFormIframe" class="form-iframe" src=""></iframe></div>

<div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    
    <div class="sidenav-header">
        <img id="nav-logo" src="" alt="Logo">
        <h3 style="margin: 5px 0 0 0; color: var(--primary-color);">Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®Ø²Ù†</h3>
    </div>

    <div id="categories-container"></div>
</div>

<button id="back-fab" onclick="goBack()">ğŸ”™</button>

<div class="container">
  <button class="menu-btn" onclick="openNav()">â˜°</button>
  <div id="scan-screen">
    <img id="company-logo" src="" class="app-logo" alt="Logo" onerror="this.style.display='none'">
    <h2 style="color:var(--primary-color); margin-top:0; font-size: 22px; font-weight: 800;">Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    
    <div id="connection-badge" class="connection-badge conn-checking">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„...</div>
    <div id="status" class="status-msg loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <button class="refresh-btn" onclick="fetchProducts(true)">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    
    <div class="search-wrapper"><input type="text" id="search-input" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯..." onkeyup="suggestProducts()" autocomplete="off"><div id="suggestions" class="suggestions-list"></div></div>
    
    <div class="scanner-wrapper">
        <div id="reader"></div>
        <div class="laser-beam"></div>
        <div class="scan-overlay"><div class="scan-corners-bottom"></div></div>
        
        <div id="camera-error-layer" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:50; flex-direction:column; align-items:center; justify-content:center;">
             <p style="color:#fff; margin-bottom:15px; font-weight:bold;">âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§</p>
             <button class="fix-camera-btn" onclick="forceRestartCamera()">ğŸ”„ Ø§Ø¶ØºØ· Ù„Ù„Ø¥Ù†Ø¹Ø§Ø´</button>
        </div>
    </div>
    
    <div class="zoom-controls" id="zoom-controls" style="display:none;">
        <span class="zoom-label">Zoom:</span>
        <input type="range" id="zoom-slider" min="1" max="3" step="0.1" value="1" oninput="applyZoom(this.value)">
    </div>
    
    <a id="add-btn" href="#" target="_blank" class="btn btn-warning">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</a>
  </div>

  <div id="list-screen">
      <h3 id="category-title" style="text-align:center; margin-top:15px; color:var(--text-dark); font-weight: 800;"></h3>
      <div id="subcategories-filter" class="sub-cats-container"></div>
      <div id="list-content"></div>
  </div>

  <div id="result-screen" class="result-box">
    <img id="p_img" src="" class="product-img" onerror="this.style.display='none'" onclick="openImageModal(this.src)">
    <p style="font-size:12px; color:#999; margin-top:-15px; margin-bottom:20px;">(Ø§Ø¶ØºØ· Ù„Ù„ØªÙƒØ¨ÙŠØ±)</p>
    <div style="text-align: right;">
        <div class="detail-row"> <span class="detail-label">Ø§Ù„Ù‚Ø³Ù…:</span> <span id="p_cat" class="detail-value"></span> </div>
        <div class="detail-row"> <span class="detail-label">Ø§Ù„ÙØ±Ø¹:</span> <span id="p_subcat" class="detail-value"></span> </div>
        <div class="detail-row"> <span class="detail-label">Ø§Ù„Ù…Ù†ØªØ¬:</span> <span id="p_name" class="detail-value"></span> </div>
        <div class="detail-row"> <span class="detail-label">Ø¨Ø§Ø±ÙƒÙˆØ¯ (C):</span> <span id="p_code_local" class="detail-value barcode-style"></span> </div>
        <div class="detail-row"> <span class="detail-label">Ø¨Ø§Ø±ÙƒÙˆØ¯ (D):</span> <span id="p_code_global" class="detail-value barcode-style"></span> </div>
    </div>
    <div id="prices-container"></div>
    <div class="action-buttons">
        <button class="btn btn-primary" onclick="goBack()">Ø±Ø¬ÙˆØ¹</button>
        <button class="btn btn-edit" onclick="editCurrentProduct()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±</button>
    </div>
  </div>
  <div class="designer-footer">ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ±: <span id="designer-name"></span></div>
</div>

<script>
    // ============================================================
    // ğŸ”´ğŸ”´ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ù„Ø§ ØªÙ†Ø³ Ù…Ù„Ø£Ù‡Ø§) ğŸ”´ğŸ”´
    // ============================================================
    const SHEET_CSV_URL = "Ø¶Ø¹_Ø±Ø§Ø¨Ø·_CSV_Ù‡Ù†Ø§"; 
    const GOOGLE_FORM_URL = "Ø¶Ø¹_Ø±Ø§Ø¨Ø·_Ø§Ù„ÙÙˆØ±Ù…_Ù‡Ù†Ø§";
    const LOGO_URL = "Ø¶Ø¹_Ø±Ø§Ø¨Ø·_Ø§Ù„Ø´Ø¹Ø§Ø±_Ù‡Ù†Ø§"; 
    const DESIGNER_NAME = "Ø§Ø³Ù… Ø§Ù„Ù…ØµÙ…Ù… Ù‡Ù†Ø§";
    
    const BARCODE_ENTRY_ID = "Ø¶Ø¹_Ø±Ù‚Ù…_Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯_Ù‡Ù†Ø§"; 
    const NAME_ENTRY_ID = ""; 
    const PRICE1_ENTRY_ID = ""; 
    // ============================================================

    if(LOGO_URL && LOGO_URL !== "") { 
        document.getElementById('company-logo').src = LOGO_URL; 
        document.getElementById('nav-logo').src = LOGO_URL; // ØªØ­Ø¯ÙŠØ« Ø´Ø¹Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹
    } else { 
        document.getElementById('company-logo').style.display = 'none'; 
        document.getElementById('nav-logo').style.display = 'none';
    }
    document.getElementById('designer-name').innerText = DESIGNER_NAME;

    async function checkRealConnection() {
        try { const response = await fetch(SHEET_CSV_URL + "&ping=" + new Date().getTime(), { method: 'HEAD', cache: 'no-store' }); return true; } 
        catch (error) { return false; }
    }
    function updateBadge(isOnline) {
        const badge = document.getElementById('connection-badge');
        if (isOnline) { badge.innerText = "Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª âœ…"; badge.className = "connection-badge conn-online"; } 
        else { badge.innerText = "ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† âš ï¸"; badge.className = "connection-badge conn-offline"; }
    }
    setInterval(async () => { const online = await checkRealConnection(); updateBadge(online); }, 5000);
    checkRealConnection().then(updateBadge);

    function openFormModal(url) { document.getElementById('googleFormIframe').src = url; document.getElementById('formModal').style.display = 'block'; }
    function closeFormModal() { document.getElementById('formModal').style.display = 'none'; document.getElementById('googleFormIframe').src = ""; resetScanner(); }

    var audioCtx = null;
    function playScanSound() {
        if (navigator.vibrate) { navigator.vibrate(200); }
        try { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = 'square'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); 
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime); 
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1); 
        } catch(e) {}
    }

    function openImageModal(src) { var modal = document.getElementById("imageModal"); var modalImg = document.getElementById("img01"); modal.style.display = "block"; modalImg.src = src; }
    function closeImageModal() { document.getElementById("imageModal").style.display = "none"; }

    var productsList = []; var categoriesSet = new Set(); var html5QrcodeScanner;
    const statusDiv = document.getElementById('status');
    var lastScreen = "scan-screen"; var currentProduct = null;
    var videoTrack = null;
    var isProcessing = false;

    document.getElementById('add-btn').onclick = function() { openFormModal(GOOGLE_FORM_URL); };

    function openNav() { document.getElementById("mySidenav").style.width = "280px"; /* Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */ }
    function closeNav() { document.getElementById("mySidenav").style.width = "0"; }
    
    function updateCategoriesMenu() {
        let container = document.getElementById('categories-container'); container.innerHTML = "";
        let sortedCats = Array.from(categoriesSet).sort();
        if(sortedCats.length === 0) { container.innerHTML = "<a href='#'>ÙØ§Ø±Øº</a>"; return; }
        sortedCats.forEach(cat => {
            let link = document.createElement('a'); link.href = "#"; link.innerText = cat;
            link.onclick = function() { showCategoryProducts(cat); closeNav(); }; container.appendChild(link);
        });
    }

    function showCategoryProducts(catName) {
        lastScreen = "scan-screen"; updateBackButton();
        document.getElementById('scan-screen').style.display = 'none'; document.getElementById('result-screen').style.display = 'none';
        document.getElementById('list-screen').style.display = 'block';
        document.getElementById('category-title').innerText = catName;
        let listDiv = document.getElementById('list-content'); let subCatDiv = document.getElementById('subcategories-filter');
        listDiv.innerHTML = ""; subCatDiv.innerHTML = "";
        let subCatsInThisCat = new Set(); 
        let productsInThisCat = productsList.filter(p => p.category === catName);
        productsInThisCat.forEach(p => { if(p.subcategory) subCatsInThisCat.add(p.subcategory); });
        if(subCatsInThisCat.size > 0) {
            let allBtn = document.createElement('button'); allBtn.innerText = "Ø§Ù„ÙƒÙ„"; allBtn.className = "sub-cat-btn active";
            allBtn.onclick = function() { filterList(this, 'ALL', productsInThisCat); }; subCatDiv.appendChild(allBtn);
            subCatsInThisCat.forEach(sub => {
                let btn = document.createElement('button'); btn.innerText = sub; btn.className = "sub-cat-btn";
                btn.onclick = function() { filterList(this, sub, productsInThisCat); }; subCatDiv.appendChild(btn);
            });
        }
        renderList(productsInThisCat);
        updateBackButton();
    }

    function renderList(items) {
        let listDiv = document.getElementById('list-content'); listDiv.innerHTML = "";
        if(items.length === 0) { listDiv.innerHTML = "<p style='text-align:center; color:#999;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p>"; return; }
        let uniqueItems = []; let seenNames = new Set();
        let reversedItems = [...items].reverse();
        reversedItems.forEach(p => { if(!seenNames.has(p.name)){ seenNames.add(p.name); uniqueItems.push(p); } });
        uniqueItems.forEach(p => {
            let div = document.createElement('div'); div.className = 'suggestion-item';
            let imgTag = (p.img && p.img.startsWith('http')) ? `<img src="${p.img}" class="suggestion-thumb">` : '';
            div.innerHTML = `<div class="prod-info-flex">${imgTag}<span>${p.name}</span></div><span style="color:var(--primary-color); font-weight:bold;">${p.price1} Ø¬.Ù…</span>`;
            div.onclick = function() { showResultScreen(p, 'list-screen'); }; listDiv.appendChild(div);
        });
    }

    function filterList(btn, filter, allItems) {
        let buttons = document.querySelectorAll('.sub-cat-btn');
        buttons.forEach(b => b.classList.remove('active')); btn.classList.add('active');
        if(filter === 'ALL') { renderList(allItems); } else { let filtered = allItems.filter(p => p.subcategory === filter); renderList(filtered); }
    }

    async function fetchProducts(force = false) {
      showStatus("ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...", "loading");
      if (!navigator.onLine) { loadFromCache(); return; }
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); 
      let fetchUrl = SHEET_CSV_URL;
      if(force) { fetchUrl += (fetchUrl.includes('?') ? '&' : '?') + "nocache=" + new Date().getTime(); }
      try {
        const response = await fetch(fetchUrl, { cache: "no-store", signal: controller.signal });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error("Network error");
        const data = await response.text(); 
        localStorage.setItem('offline_products_csv', data); 
        parseCSV(data);
        showStatus("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…", "loading"); 
        setTimeout(() => { statusDiv.style.display = 'none'; }, 1000);
        if (document.getElementById('result-screen').style.display === 'block' && currentProduct) {
             let updatedProduct = findProductInDB(currentProduct.code1 || currentProduct.code2);
             if (updatedProduct) { showResultScreen(updatedProduct, 'scan-screen'); alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø±!"); }
        }
      } catch (error) {
        loadFromCache();
      }
    }

    function loadFromCache() {
        const cachedData = localStorage.getItem('offline_products_csv');
        if (cachedData) { parseCSV(cachedData); showStatus("âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ†", "loading"); setTimeout(() => { statusDiv.style.display = 'none'; }, 2000); }
        else { showStatus("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª", "error"); }
    }

    function sanitizeBarcode(text) {
        if(!text) return "";
        let clean = text; if(clean.includes('.')) { clean = clean.split('.')[0]; } 
        clean = clean.replace(/[^a-zA-Z0-9]/g, ''); return clean;
    }

    function parseCSV(csvText) {
      let cleanText = csvText.replace(/"([^"]*)"/g, function(match, group1) { return '"' + group1.replace(/[\r\n]+/g, ' ') + '"'; });
      const rows = cleanText.split('\n'); productsList = []; categoriesSet.clear();
      let tempMap = new Map();

      for (let i = 1; i < rows.length; i++) {
        if(!rows[i].trim()) continue;
        const row = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        if (row.length >= 11) { 
          const localCode = sanitizeBarcode(row[2]); 
          const globalCode = sanitizeBarcode(row[3]); 
          const name = clean(row[4]); 
          let p1 = cleanPrice(row[5]); let p2 = cleanPrice(row[6]); let p3 = cleanPrice(row[7]); 
          const img = row[8] ? clean(row[8]) : ""; const cat = row[9] ? clean(row[9]) : "Ø¹Ø§Ù…"; const sub = row[10] ? clean(row[10]) : ""; 

          let productData = { 
              code1: localCode, code2: globalCode, 
              name: name, price1: p1, price2: p2, price3: p3, 
              img: img, category: cat, subcategory: sub 
          };

          if(localCode && tempMap.has(localCode)) {
              let oldData = tempMap.get(localCode);
              if(!productData.img) productData.img = oldData.img;
              if(!productData.category || productData.category === "Ø¹Ø§Ù…") productData.category = oldData.category;
              if(!productData.subcategory) productData.subcategory = oldData.subcategory;
              if(!productData.name) productData.name = oldData.name;
          } else if(globalCode && tempMap.has(globalCode)) {
              let oldData = tempMap.get(globalCode);
              if(!productData.img) productData.img = oldData.img;
              if(!productData.category || productData.category === "Ø¹Ø§Ù…") productData.category = oldData.category;
              if(!productData.subcategory) productData.subcategory = oldData.subcategory;
              if(!productData.name) productData.name = oldData.name;
          }

          if(localCode) tempMap.set(localCode, productData);
          if(globalCode) tempMap.set(globalCode, productData);
        }
      }
      productsList = Array.from(tempMap.values());
      productsList = [...new Set(productsList)];
      productsList.forEach(p => categoriesSet.add(p.category));
      updateCategoriesMenu();
    }

    function clean(text) { return text ? text.replace(/"/g, '').trim() : ""; }
    function cleanPrice(text) { if(!text) return ""; return text.replace(/"/g, '').replace('Ø¬.Ù…', '').replace('$', '').trim(); }

    function suggestProducts() {
        let inputVal = document.getElementById('search-input').value.toLowerCase().trim();
        let listDiv = document.getElementById('suggestions'); listDiv.innerHTML = ""; 
        if (inputVal.length < 1) { listDiv.style.display = "none"; return; }
        let matchCount = 0; let seenNames = new Set(); 

        for (let i = productsList.length - 1; i >= 0; i--) {
            let p = productsList[i];
            if (p.name.toLowerCase().includes(inputVal) || (p.code1 && p.code1.includes(inputVal)) || (p.code2 && p.code2.includes(inputVal))) {
                if(seenNames.has(p.name)) continue; seenNames.add(p.name);
                let item = document.createElement('div'); item.className = 'suggestion-item';
                let imgTag = (p.img && p.img.startsWith('http')) ? `<img src="${p.img}" class="suggestion-thumb">` : '';
                item.innerHTML = `<div class="prod-info-flex">${imgTag}<span>${p.name}</span></div><span style="color:var(--primary-color)">${p.price1} Ø¬.Ù…</span>`;
                item.onclick = function() { showResultScreen(p, 'scan-screen'); document.getElementById('search-input').value = ""; listDiv.style.display = "none"; };
                listDiv.appendChild(item); matchCount++; if(matchCount >= 10) break;
            }
        }
        listDiv.style.display = (matchCount > 0) ? "block" : "none";
    }

    function findProductInDB(scannedCode) {
        let code = sanitizeBarcode(scannedCode);
        for(let i = productsList.length - 1; i >= 0; i--) {
            let p = productsList[i];
            if(p.code1 === code || p.code2 === code) return p;
            if(p.code1 === code.replace(/^0+/, '')) return p;
            if(p.code2 === code.replace(/^0+/, '')) return p;
        }
        return null;
    }

    async function onScanSuccess(decodedText, decodedResult) {
      if(isProcessing) return;
      isProcessing = true; // Ù‚ÙÙ„
      playScanSound();
      
      try { await html5QrcodeScanner.clear(); } catch(e) {}
      
      let cleanCode = sanitizeBarcode(decodedText);
      let foundProduct = findProductInDB(cleanCode);
      
      if (foundProduct) { 
          showResultScreen(foundProduct, 'scan-screen'); 
      } else { 
          if(confirm("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø³Ø¬Ù„: " + cleanCode + "\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡ØŸ")) { 
              let sep = GOOGLE_FORM_URL.includes('?') ? '&' : '?';
              openFormModal(GOOGLE_FORM_URL + sep + "usp=pp_url&entry." + BARCODE_ENTRY_ID + "=" + cleanCode);
          } else { 
              forceRestartCamera();
          } 
      }
    }

    function editCurrentProduct() {
        if(!currentProduct) return;
        let code = currentProduct.code2 || currentProduct.code1;
        let sep = GOOGLE_FORM_URL.includes('?') ? '&' : '?';
        let link = GOOGLE_FORM_URL + sep + "usp=pp_url";
        if(BARCODE_ENTRY_ID) link += "&entry." + BARCODE_ENTRY_ID + "=" + code;
        if(NAME_ENTRY_ID) link += "&entry." + NAME_ENTRY_ID + "=" + encodeURIComponent(currentProduct.name);
        if(PRICE1_ENTRY_ID) link += "&entry." + PRICE1_ENTRY_ID + "=" + currentProduct.price1;
        openFormModal(link);
    }

    function showResultScreen(product, source = 'scan-screen') {
        currentProduct = product; lastScreen = source; updateBackButton();
        document.getElementById('scan-screen').style.display = 'none'; document.getElementById('list-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        document.getElementById('p_cat').innerText = product.category; document.getElementById('p_subcat').innerText = product.subcategory || "-"; document.getElementById('p_name').innerText = product.name; 
        document.getElementById('p_code_local').innerText = product.code1 || "-"; document.getElementById('p_code_global').innerText = product.code2 || "-";
        const imgElem = document.getElementById('p_img');
        if(product.img && product.img.startsWith('http')) { imgElem.src = product.img; imgElem.style.display = 'inline-block'; } else { imgElem.style.display = 'none'; }
        let priceHTML = `<table class="prices-table"><thead><tr><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th></tr></thead><tbody>`;
        if(product.price1) priceHTML += `<tr><td>Ù‚Ø·Ø¹Ø©</td><td class="price-val">${product.price1} Ø¬.Ù…</td></tr>`;
        if(product.price2) priceHTML += `<tr><td>Ø¯Ø³ØªØ©</td><td class="price-val">${product.price2} Ø¬.Ù…</td></tr>`;
        if(product.price3) priceHTML += `<tr><td>ÙƒØ±ØªÙˆÙ†Ø©</td><td class="price-val">${product.price3} Ø¬.Ù…</td></tr>`;
        priceHTML += `</tbody></table>`;
        document.getElementById('prices-container').innerHTML = priceHTML;
        updateBackButton();
    }

    function goBack() {
        if(document.getElementById('result-screen').style.display === 'block') {
            if(lastScreen === 'list-screen') {
                document.getElementById('result-screen').style.display = 'none'; document.getElementById('list-screen').style.display = 'block'; updateBackButton();
            } else { forceRestartCamera(); }
        } else if(document.getElementById('list-screen').style.display === 'block') { forceRestartCamera(); }
    }

    function updateBackButton() {
        let btn = document.getElementById('back-fab');
        if(document.getElementById('scan-screen').style.display === 'block') { btn.style.display = 'none'; } else { btn.style.display = 'flex'; }
    }

    function resetScanner() {
        document.getElementById('result-screen').style.display = 'none'; document.getElementById('list-screen').style.display = 'none';
        document.getElementById('scan-screen').style.display = 'block'; document.getElementById('suggestions').style.display = "none";
        isProcessing = false;
        updateBackButton(); startCamera();
    }

    function applyZoom(val) {
        if(videoTrack) { try { videoTrack.applyConstraints({ advanced: [{ zoom: parseFloat(val) }] }); } catch(e) {} }
    }

    function forceRestartCamera() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('list-screen').style.display = 'none';
        document.getElementById('scan-screen').style.display = 'block';
        document.getElementById('camera-error-layer').style.display = 'none';
        document.getElementById('reader').innerHTML = "";
        
        if(html5QrcodeScanner) { try { html5QrcodeScanner.clear(); } catch(e) {} html5QrcodeScanner = null; }
        isProcessing = false;
        setTimeout(() => { startCamera(); }, 300);
    }

    function startCamera() {
      if(document.getElementById('reader').innerHTML !== "") return;
      
      setTimeout(() => {
          html5QrcodeScanner = new Html5QrcodeScanner("reader", { 
              fps: 10, 
              qrbox: { width: 250, height: 150 }, 
              aspectRatio: 1.3,
              videoConstraints: { facingMode: "environment" },
              formatsToSupport: [
                   Html5QrcodeSupportedFormats.QR_CODE, Html5QrcodeSupportedFormats.BARCODE, Html5QrcodeSupportedFormats.UPC_A, Html5QrcodeSupportedFormats.UPC_E,
                   Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.EAN_8, Html5QrcodeSupportedFormats.CODE_39, Html5QrcodeSupportedFormats.CODE_93,
                   Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.ITF, Html5QrcodeSupportedFormats.RSS_14, Html5QrcodeSupportedFormats.RSS_EXPANDED,
                   Html5QrcodeSupportedFormats.PDF_417, Html5QrcodeSupportedFormats.AZTEC, Html5QrcodeSupportedFormats.DATA_MATRIX, Html5QrcodeSupportedFormats.MAXICODE
              ],
              useBarCodeDetectorIfSupported: true 
          });
          
          html5QrcodeScanner.render(onScanSuccess, (errorMessage) => {});

          html5QrcodeScanner.html5Qrcode.catch(err => {
               if(err && err.name == "NotReadableError") {
                   document.getElementById('camera-error-layer').style.display = 'flex';
               }
          });

          setTimeout(() => {
              try {
                  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", zoom: true } })
                  .then(stream => {
                      const track = stream.getVideoTracks()[0];
                      const capabilities = track.getCapabilities();
                      if ('zoom' in capabilities) {
                          videoTrack = track;
                          document.getElementById('zoom-controls').style.display = 'flex';
                          document.getElementById('zoom-slider').min = capabilities.zoom.min;
                          document.getElementById('zoom-slider').max = capabilities.zoom.max;
                          document.getElementById('zoom-slider').step = capabilities.zoom.step;
                      }
                  });
              } catch(e) {}
          }, 2000);

      }, 300);
    }
    
    function showStatus(text, type) { statusDiv.innerText = text; statusDiv.className = "status-msg " + type; statusDiv.style.display = 'block'; }
    
    (function initApp() {
        startCamera(); 
        fetchProducts();
    })();
</script>
</body>
</html>
