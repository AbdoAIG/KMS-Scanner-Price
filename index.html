<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 0; background-color: #1a1a1a; margin: 0; color: white; }
  .container { max-width: 600px; margin: 10px auto; background: #222; padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; min-height: 90vh; border: 1px solid #333; }
  
  /* Ø§Ù„Ø´Ø¹Ø§Ø± */
  .app-logo { max-width: 140px; max-height: 70px; display: block; margin: 0 auto 15px auto; object-fit: contain; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); }

  /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
  .menu-btn { position: absolute; top: 15px; right: 15px; font-size: 26px; cursor: pointer; background: none; border: none; color: #fff; z-index: 100; text-shadow: 0 0 10px black; }
  .sidenav { height: 100%; width: 0; position: fixed; z-index: 2000; top: 0; right: 0; background-color: #111; overflow-x: hidden; transition: 0.3s; padding-top: 60px; text-align: right; border-left: 1px solid #333; }
  .sidenav a { padding: 12px 15px 12px 32px; text-decoration: none; font-size: 18px; color: #ccc; display: block; transition: 0.3s; border-bottom: 1px solid #222; margin-right: 5px; }
  .sidenav a:hover { color: #fff; background: #007bff; }
  .sidenav .closebtn { position: absolute; top: 0; right: 25px; font-size: 36px; margin-left: 50px; border: none; background: none; }
  
  /* Ø§Ù„Ø¨Ø­Ø« */
  .search-wrapper { position: relative; margin-bottom: 20px; }
  .search-input { width: 100%; padding: 14px; background: #333; border: 2px solid #444; color: white; border-radius: 12px; font-size: 16px; box-sizing: border-box; outline: none; transition: 0.3s; }
  .search-input:focus { border-color: #007bff; box-shadow: 0 0 15px rgba(0,123,255,0.3); }
  .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: #333; border: 1px solid #444; border-radius: 0 0 12px 12px; z-index: 1000; max-height: 250px; overflow-y: auto; display: none; }
  .suggestion-item { padding: 15px; border-bottom: 1px solid #444; text-align: right; cursor: pointer; display: flex; justify-content: space-between; color: white; }
  .suggestion-item:hover { background-color: #444; }

  /* --- ğŸ“· ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ) --- */
  .scanner-wrapper { position: relative; width: 100%; height: 300px; margin-bottom: 20px; border-radius: 15px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.8); border: 2px solid #444; }
  #reader { width: 100%; height: 100%; object-fit: cover; }
  
  /* Ø®Ø· Ø§Ù„Ù„ÙŠØ²Ø± Ø§Ù„Ù…ØªØ­Ø±Ùƒ */
  .laser-beam {
      position: absolute; width: 100%; height: 2px; background: red;
      box-shadow: 0 0 15px red, 0 0 30px red;
      top: 0; left: 0; z-index: 10;
      animation: scan-anim 2s infinite ease-in-out;
      opacity: 0.8;
      pointer-events: none; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¶ØºØ· Ù…Ù† Ø®Ù„Ø§Ù„Ù‡ */
  }
  @keyframes scan-anim {
      0% { top: 10%; opacity: 0; }
      50% { opacity: 1; }
      100% { top: 90%; opacity: 0; }
  }

  /* Ø¥Ø·Ø§Ø± Ø§Ù„Ø²ÙˆØ§ÙŠØ§ (Viewfinder) */
  .scan-overlay {
      position: absolute; top: 20px; left: 20px; right: 20px; bottom: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      pointer-events: none;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
  }
  .scan-overlay::before, .scan-overlay::after {
      content: ''; position: absolute; width: 30px; height: 30px;
      border-color: #007bff; border-style: solid; border-width: 0;
      transition: 0.3s;
  }
  /* Ø§Ù„Ø²ÙˆØ§ÙŠØ§ Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
  .scan-overlay::before { top: -2px; left: -2px; border-top-width: 4px; border-left-width: 4px; border-radius: 8px 0 0 0; }
  .scan-overlay::after { top: -2px; right: -2px; border-top-width: 4px; border-right-width: 4px; border-radius: 0 8px 0 0; }
  /* Ø§Ù„Ø²ÙˆØ§ÙŠØ§ Ø§Ù„Ø³ÙÙ„ÙŠØ© (Ø¹Ù†Ø§ØµØ± Ø¥Ø¶Ø§ÙÙŠØ©) */
  .scan-corners-bottom { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
  .scan-corners-bottom::before, .scan-corners-bottom::after {
      content: ''; position: absolute; width: 30px; height: 30px;
      border-color: #007bff; border-style: solid; border-width: 0;
  }
  .scan-corners-bottom::before { bottom: -2px; left: -2px; border-bottom-width: 4px; border-left-width: 4px; border-radius: 0 0 0 8px; }
  .scan-corners-bottom::after { bottom: -2px; right: -2px; border-bottom-width: 4px; border-right-width: 4px; border-radius: 0 0 8px 0; }

  /* Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
  #list-screen, .result-box { display: none; text-align: right; }
  .result-box { text-align: center; background: #333; padding: 20px; border-radius: 15px; }
  .product-img { width: 100%; max-width: 200px; height: 200px; object-fit: contain; border-radius: 10px; margin-bottom: 15px; border: 1px solid #555; background: white; cursor: pointer; }
  
  /* Ø´Ø§Ø´Ø© Ø§Ù„ØªÙƒØ¨ÙŠØ± */
  .modal { display: none; position: fixed; z-index: 5000; padding-top: 50px; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.95); }
  .modal-content { margin: auto; display: block; width: 95%; max-width: 700px; object-fit: contain; border: 2px solid white; border-radius: 10px; }
  .close-zoom { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; }

  .price { font-size: 36px; color: #2ecc71; font-weight: bold; margin: 10px 0; text-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }
  .name { font-size: 24px; font-weight: bold; color: white; margin-bottom: 5px; }
  .category-tag { background: #444; padding: 6px 12px; border-radius: 20px; font-size: 13px; color: #ccc; display: inline-block; margin-bottom: 10px; border: 1px solid #555; }
  
  /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
  .btn { display: block; width: 100%; padding: 14px; margin-top: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
  .btn-primary { background: linear-gradient(45deg, #007bff, #0056b3); box-shadow: 0 4px 15px rgba(0,123,255,0.4); }
  .btn-warning { background: linear-gradient(45deg, #f1c40f, #f39c12); color: #222; box-shadow: 0 4px 15px rgba(241, 196, 15, 0.4); }
  .btn-secondary { background: #555; color: #ccc; }
  
  .status-msg { margin: 10px 0; font-size: 14px; padding: 10px; border-radius: 8px; display: none; }
  .loading { background-color: #333; color: #ccc; border: 1px solid #444; }
  .offline { background-color: #856404; color: #fff; border: 1px solid #ffeeba; }
  .error { background-color: #721c24; color: #fff; }
</style>
</head>
<body>

<div id="imageModal" class="modal" onclick="closeImageModal()"><span class="close-zoom">&times;</span><img class="modal-content" id="img01"></div>

<div id="mySidenav" class="sidenav">
  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  <h3 style="color:white; padding-right:15px; border-bottom:1px solid #444; padding-bottom:15px;">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
  <div id="categories-container"></div>
</div>

<div class="container">
  
  <button class="menu-btn" onclick="openNav()">â˜°</button>

  <div id="scan-screen">
    <img id="company-logo" src="" class="app-logo" alt="Logo" onerror="this.style.display='none'">
    <h2 style="color:white; font-weight:300;">Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <div id="status" class="status-msg loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <div class="search-wrapper">
        <input type="text" id="search-input" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." onkeyup="suggestProducts()" autocomplete="off">
        <div id="suggestions" class="suggestions-list"></div>
    </div>

    <div class="scanner-wrapper">
        <div id="reader"></div>
        <div class="laser-beam"></div> <div class="scan-overlay"> <div class="scan-corners-bottom"></div>
        </div>
    </div>
    
    <a id="add-btn" href="#" target="_blank" class="btn btn-warning">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</a>
  </div>

  <div id="list-screen">
      <button class="btn btn-secondary" onclick="resetScanner()">ğŸ”™ Ø¹ÙˆØ¯Ø©</button>
      <h3 id="category-title" style="text-align:center; margin-top:15px; color:white;"></h3>
      <div id="list-content" style="color:white;"></div>
  </div>

  <div id="result-screen" class="result-box">
    <img id="p_img" src="" class="product-img" onerror="this.style.display='none'" onclick="openImageModal(this.src)">
    <p style="font-size:12px; color:#888;">(Ø§Ø¶ØºØ· Ù„Ù„ØªÙƒØ¨ÙŠØ±)</p>
    <div id="p_cat" class="category-tag"></div>
    <div id="p_name" class="name"></div>
    <div id="p_price" class="price"></div>
    <hr style="border:0; border-top:1px solid #444; margin: 20px 0;">
    <button class="btn btn-primary" onclick="resetScanner()">Ø¨Ø­Ø« Ø¢Ø®Ø±</button>
  </div>

</div>

<script>
    // ============================================================
    // ğŸ”´ğŸ”´ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ğŸ”´ğŸ”´
    // ============================================================
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKotb6frhhZzBOkKyvUu0V1x06UkENSEkdtSn52yfc7OG030tDMxwjjjEX8tV1UGgpNzMTuObGRur3/pub?gid=0&single=true&output=csv"; 
    const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfT5WLBAE4dTq-uprfqbVnX1K8HWrOs8AlyGH60IdEkBee2Kg/viewform?usp=header";
    const LOGO_URL = "https://e.top4top.io/p_36206u8ei1.png"; 
    // ============================================================

    if(LOGO_URL && LOGO_URL !== "") { document.getElementById('company-logo').src = LOGO_URL; } 
    else { document.getElementById('company-logo').style.display = 'none'; }

    function openImageModal(src) { var modal = document.getElementById("imageModal"); var modalImg = document.getElementById("img01"); modal.style.display = "block"; modalImg.src = src; }
    function closeImageModal() { document.getElementById("imageModal").style.display = "none"; }

    var productsDB = {}; var categoriesSet = new Set(); var html5QrcodeScanner;
    const statusDiv = document.getElementById('status');
    document.getElementById('add-btn').href = GOOGLE_FORM_URL;

    function openNav() { document.getElementById("mySidenav").style.width = "250px"; }
    function closeNav() { document.getElementById("mySidenav").style.width = "0"; }
    function updateCategoriesMenu() {
        let container = document.getElementById('categories-container'); container.innerHTML = "";
        let sortedCats = Array.from(categoriesSet).sort();
        if(sortedCats.length === 0) { container.innerHTML = "<a href='#'>ÙØ§Ø±Øº</a>"; return; }
        sortedCats.forEach(cat => {
            let link = document.createElement('a'); link.href = "#"; link.innerText = cat;
            link.onclick = function() { showCategoryProducts(cat); closeNav(); }; container.appendChild(link);
        });
    }

    function showCategoryProducts(catName) {
        document.getElementById('scan-screen').style.display = 'none'; document.getElementById('result-screen').style.display = 'none';
        document.getElementById('list-screen').style.display = 'block';
        document.getElementById('category-title').innerText = catName;
        let listDiv = document.getElementById('list-content'); listDiv.innerHTML = "";
        for (let code in productsDB) {
            let p = productsDB[code];
            if (p.category === catName) {
                let div = document.createElement('div'); div.className = 'suggestion-item';
                div.innerHTML = `<span>${p.name}</span><span style="color:#2ecc71">${p.price} Ø¬.Ù…</span>`;
                div.onclick = function() { showResultScreen(p); }; listDiv.appendChild(div);
            }
        }
    }

    async function fetchProducts() {
      showStatus("ğŸ”„ ØªØ­Ø¯ÙŠØ«...", "loading");
      try {
        const response = await fetch(SHEET_CSV_URL, { cache: "no-store" });
        if (!response.ok) throw new Error("Network error");
        const data = await response.text(); localStorage.setItem('offline_products_csv', data); parseCSV(data);
        showStatus("Ù…ØªØµÙ„ âœ…", "loading"); setTimeout(() => { statusDiv.style.display = 'none'; }, 1000);
      } catch (error) {
        const cachedData = localStorage.getItem('offline_products_csv');
        if (cachedData) { parseCSV(cachedData); showStatus("âš ï¸ Ø£ÙˆÙÙ„Ø§ÙŠÙ†", "loading"); }
        else { showStatus("âŒ Ø®Ø·Ø£ Ù†Øª", "error"); }
      }
    }

    function parseCSV(csvText) {
      const rows = csvText.split('\n'); productsDB = {}; categoriesSet.clear();
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i].split(','); 
        if (row.length >= 4) {
          const code = clean(row[1]); const name = clean(row[2]); 
          let rawPrice = clean(row[3]).replace(/[^0-9.]/g, '');
          const img = row[4] ? clean(row[4]) : ""; const cat = row[5] ? clean(row[5]) : "Ø¹Ø§Ù…"; 
          if(code) { productsDB[code] = { name: name, price: rawPrice, img: img, category: cat }; categoriesSet.add(cat); }
        }
      }
      updateCategoriesMenu();
    }

    function clean(text) { return text ? text.replace(/"/g, '').trim() : ""; }
    function suggestProducts() {
        let inputVal = document.getElementById('search-input').value.toLowerCase().trim();
        let listDiv = document.getElementById('suggestions'); listDiv.innerHTML = ""; 
        if (inputVal.length < 1) { listDiv.style.display = "none"; return; }
        let matchCount = 0;
        for (let code in productsDB) {
            let p = productsDB[code];
            if (p.name.toLowerCase().includes(inputVal) || code.includes(inputVal)) {
                let item = document.createElement('div'); item.className = 'suggestion-item';
                item.innerHTML = `<span>${p.name}</span><span style="color:#2ecc71">${p.price} Ø¬.Ù…</span>`;
                item.onclick = function() { showResultScreen(p); document.getElementById('search-input').value = ""; listDiv.style.display = "none"; };
                listDiv.appendChild(item); matchCount++; if(matchCount >= 10) break;
            }
        }
        listDiv.style.display = (matchCount > 0) ? "block" : "none";
    }

    function onScanSuccess(decodedText, decodedResult) {
      if(html5QrcodeScanner) html5QrcodeScanner.clear();
      if (productsDB[decodedText]) { showResultScreen(productsDB[decodedText]); }
      else { if(confirm("ØºÙŠØ± Ù…Ø³Ø¬Ù„: " + decodedText + "\nØ¥Ø¶Ø§ÙØ©ØŸ")) { window.open(GOOGLE_FORM_URL, '_blank'); resetScanner(); } else { resetScanner(); } }
    }

    function showResultScreen(product) {
      document.getElementById('scan-screen').style.display = 'none'; document.getElementById('list-screen').style.display = 'none';
      document.getElementById('result-screen').style.display = 'block';
      document.getElementById('p_cat').innerText = product.category; document.getElementById('p_name').innerText = product.name;
      document.getElementById('p_price').innerText = product.price + " Ø¬.Ù…";
      const imgElem = document.getElementById('p_img');
      if(product.img && product.img.startsWith('http')) { imgElem.src = product.img; imgElem.style.display = 'inline-block'; } else { imgElem.style.display = 'none'; }
    }

    function resetScanner() {
      document.getElementById('result-screen').style.display = 'none'; document.getElementById('list-screen').style.display = 'none';
      document.getElementById('scan-screen').style.display = 'block'; document.getElementById('suggestions').style.display = "none";
      startCamera();
    }

    function startCamera() {
      document.getElementById('reader').innerHTML = "";
      html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, videoConstraints: { facingMode: "environment" } });
      html5QrcodeScanner.render(onScanSuccess);
    }
    
    function showStatus(text, type) { statusDiv.innerText = text; statusDiv.className = "status-msg " + type; statusDiv.style.display = 'block'; }
    fetchProducts().then(() => { startCamera(); });
</script>
</body>
</html>
