<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø®Ø²Ù† (Ù†Ø³Ø®Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ)</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  :root { --primary-color: #0056b3; --secondary-color: #007bff; --bg-color: #f4f7f6; --text-color: #333; }
  body { font-family: sans-serif; text-align: center; background: var(--bg-color); margin: 0; }
  .container { max-width: 600px; margin: 10px auto; background: #fff; padding: 15px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 90vh; display: flex; flex-direction: column; }
  
  .app-logo { max-width: 140px; max-height: 80px; margin: 0 auto 10px; object-fit: contain; display: block; }
  
  /* Ø§Ù„ØªØµÙ…ÙŠÙ… */
  .scanner-wrapper { position: relative; width: 100%; height: 280px; margin-bottom: 20px; border-radius: 20px; overflow: hidden; background: #000; }
  #reader { width: 100%; height: 100%; object-fit: cover; }
  
  .search-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 10px; box-sizing: border-box; }
  
  .result-box { display: none; text-align: right; background: #fff; padding: 20px; border: 1px solid #eee; border-radius: 15px; }
  .detail-row { display: flex; justify-content: space-between; border-bottom: 1px solid #f0f0f0; padding: 10px 0; }
  .detail-label { font-weight: bold; color: var(--primary-color); }
  .barcode-style { font-family: monospace; background: #eee; padding: 2px 8px; border-radius: 4px; }
  
  .prices-table { width: 100%; margin-top: 15px; border-collapse: collapse; }
  .prices-table th { background: var(--secondary-color); color: white; padding: 8px; }
  .prices-table td { border: 1px solid #eee; padding: 8px; text-align: center; }
  
  .btn { display: block; width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 10px; color: white; cursor: pointer; font-weight: bold; }
  .btn-primary { background: var(--secondary-color); }
  .btn-warning { background: #ffc107; color: #333; }
  
  /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
  .suggestions-list { position: absolute; background: white; width: 90%; left: 5%; z-index: 1000; border: 1px solid #eee; display: none; max-height: 200px; overflow-y: auto; }
  .suggestion-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; text-align: right; }
  
  /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
  .status-msg { padding: 10px; background: #e2f0fb; color: #0056b3; border-radius: 8px; margin-bottom: 10px; display: none; }
  
  /* Ø§Ù„ØµÙˆØ±Ø© */
  .product-img { width: 100%; max-width: 200px; height: 200px; object-fit: contain; margin: 0 auto; display: block; }
  .modal { display: none; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
  .modal-content { margin: 50px auto; display: block; width: 90%; max-width: 600px; }
  .close-zoom { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }
  
  /* Ø§Ù„ÙÙˆØ±Ù… */
  .form-modal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background: white; }
  .form-iframe { width: 100%; height: 100%; border: none; }
  .close-form-btn { position: absolute; top: 10px; left: 10px; background: red; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }
</style>
</head>
<body>

<div id="imageModal" class="modal" onclick="closeImageModal()"><span class="close-zoom">&times;</span><img class="modal-content" id="img01"></div>
<div id="formModal" class="form-modal"><button class="close-form-btn" onclick="closeFormModal()">âœ– Ø¥ØºÙ„Ø§Ù‚</button><iframe id="googleFormIframe" class="form-iframe" src=""></iframe></div>

<div class="container">
  
  <div id="scan-screen">
    <img id="company-logo" src="" class="app-logo" alt="Logo" onerror="this.style.display='none'">
    <h3>Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
    <div id="status" class="status-msg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    
    <div class="search-wrapper">
        <input type="text" id="search-input" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." onkeyup="suggestProducts()" autocomplete="off">
        <div id="suggestions" class="suggestions-list"></div>
    </div>

    <div class="scanner-wrapper"><div id="reader"></div></div>
    <button class="btn btn-warning" id="add-btn">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</button>
  </div>

  <div id="result-screen" class="result-box">
    <img id="p_img" src="" class="product-img" onclick="openImageModal(this.src)">
    <div class="detail-row"><span class="detail-label">Ø§Ù„Ù…Ù†ØªØ¬:</span><span id="p_name"></span></div>
    <div class="detail-row"><span class="detail-label">Ø§Ù„Ù‚Ø³Ù…:</span><span id="p_cat"></span></div>
    <div class="detail-row"><span class="detail-label">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ù„ÙŠ:</span><span id="p_code_local" class="barcode-style"></span></div>
    <div class="detail-row"><span class="detail-label">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„ÙŠ:</span><span id="p_code_global" class="barcode-style"></span></div>
    
    <div id="prices-container"></div>
    <button class="btn btn-primary" onclick="resetScanner()">Ù…Ø³Ø­ Ù…Ù†ØªØ¬ Ø¢Ø®Ø±</button>
  </div>

</div>

<script>
    // ============================================================
    // ğŸ”´ğŸ”´ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ğŸ”´ğŸ”´
    // ============================================================
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKotb6frhhZzBOkKyvUu0V1x06UkENSEkdtSn52yfc7OG030tDMxwjjjEX8tV1UGgpNzMTuObGRur3/pub?gid=0&single=true&output=csv"; 
    const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfT5WLBAE4dTq-uprfqbVnX1K8HWrOs8AlyGH60IdEkBee2Kg/viewform?usp=header";
    const LOGO_URL = "https://kamalsaad.com/themes/theme_front/assets/images/KMS LOGO FINAL.png"; 
    const BARCODE_ENTRY_ID = "1811127320"; 
    // ============================================================

    if(LOGO_URL) document.getElementById('company-logo').src = LOGO_URL;
    
    function openImageModal(src) { document.getElementById("imageModal").style.display = "block"; document.getElementById("img01").src = src; }
    function closeImageModal() { document.getElementById("imageModal").style.display = "none"; }
    function openFormModal(url) { document.getElementById('googleFormIframe').src = url; document.getElementById('formModal').style.display = 'block'; }
    function closeFormModal() { document.getElementById('formModal').style.display = 'none'; resetScanner(); }

    var productsDB = {}; 
    var html5QrcodeScanner;
    
    // Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    document.getElementById('add-btn').onclick = function() { openFormModal(GOOGLE_FORM_URL); };

    // --- Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    async function fetchProducts() {
      document.getElementById('status').style.display = 'block';
      try {
        const response = await fetch(SHEET_CSV_URL + "&t=" + new Date().getTime(), { cache: "no-store" });
        const data = await response.text();
        parseCSV(data);
        document.getElementById('status').innerText = "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
        setTimeout(() => { document.getElementById('status').style.display = 'none'; }, 2000);
      } catch (error) {
        document.getElementById('status').innerText = "âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
      }
    }

    // --- ğŸ”´ Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© (Ø§Ù„ØªØ´Ø®ÙŠØµ) ğŸ”´ ---
    function parseCSV(csvText) {
      const rows = csvText.split('\n'); 
      productsDB = {}; 
      
      let countLocal = 0;
      let countGlobal = 0;

      for (let i = 1; i < rows.length; i++) {
        if(!rows[i].trim()) continue;
        const row = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        
        if (row.length >= 11) { 
          // Ø§Ù„Ø¹Ù…ÙˆØ¯ C Ù‡Ùˆ index 2 | Ø§Ù„Ø¹Ù…ÙˆØ¯ D Ù‡Ùˆ index 3
          // Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø³Ø­ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª ØªÙ†ØµÙŠØµ
          const localCode = row[2].replace(/["\s]/g, '').trim(); 
          const globalCode = row[3].replace(/["\s]/g, '').trim();
          
          const name = row[4].replace(/"/g, '').trim(); 
          
          let p1 = row[5].replace(/["$a-zA-Z]/g, '').trim(); 
          let p2 = row[6].replace(/["$a-zA-Z]/g, '').trim(); 
          let p3 = row[7].replace(/["$a-zA-Z]/g, '').trim(); 
          const img = row[8] ? row[8].replace(/"/g, '').trim() : ""; 
          const cat = row[9] ? row[9].replace(/"/g, '').trim() : "Ø¹Ø§Ù…"; 
          const sub = row[10] ? row[10].replace(/"/g, '').trim() : ""; 

          let productData = { 
              code1: localCode, 
              code2: globalCode, 
              name: name, price1: p1, price2: p2, price3: p3, img: img, category: cat, subcategory: sub 
          };

          // 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø­Ù„ÙŠ
          if(localCode && localCode.length > 0) { 
              productsDB[localCode] = productData; 
              countLocal++;
          }
          
          // 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯ÙˆÙ„ÙŠ
          if(globalCode && globalCode.length > 0) { 
              productsDB[globalCode] = productData; 
              countGlobal++;
          }
        }
      }
      
      // ğŸš¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ğŸš¨
      alert(`ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n- Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø­Ù„ÙŠ (C): ${countLocal}\n- Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯ÙˆÙ„ÙŠ (D): ${countGlobal}\n\nØ¥Ø°Ø§ ÙƒØ§Ù† Ø£Ø­Ø¯Ù‡Ù…Ø§ 0ØŒ ÙØ±Ø§Ø¬Ø¹ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„.`);
    }

    // --- Ø§Ù„Ø¨Ø­Ø« ---
    function suggestProducts() {
        let val = document.getElementById('search-input').value.toLowerCase().trim();
        let list = document.getElementById('suggestions'); list.innerHTML = "";
        if(val.length < 1) { list.style.display = "none"; return; }
        
        let added = new Set();
        for(let key in productsDB) {
            let p = productsDB[key];
            if((p.name.toLowerCase().includes(val) || key.includes(val)) && !added.has(p.name)) {
                added.add(p.name);
                let div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = p.name;
                div.onclick = function() { showResult(p); list.style.display = 'none'; };
                list.appendChild(div);
                if(added.size > 10) break;
            }
        }
        list.style.display = added.size > 0 ? "block" : "none";
    }

    // --- Ø§Ù„Ø³ÙƒØ§Ù†Ø± ---
    function onScanSuccess(decodedText, decodedResult) {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        let code = decodedText.replace(/["\s]/g, '').trim();
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
        if(productsDB[code]) {
            showResult(productsDB[code]);
            return;
        }
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ (Ø¥Ø²Ø§Ù„Ø© Ø£ØµÙØ§Ø± Ø¨Ø§Ø¯Ø¦Ø©)
        // Ø£Ø­ÙŠØ§Ù†Ø§ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ‚Ø±Ø£ 0123 ÙˆØ§Ù„Ø§ÙƒØ³ÙŠÙ„ 123
        if(code.startsWith('0') && productsDB[code.substring(1)]) {
            showResult(productsDB[code.substring(1)]);
            return;
        }

        // Ø¥Ø°Ø§ ÙØ´Ù„
        if(html5QrcodeScanner) html5QrcodeScanner.clear();
        if(confirm(`Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${code}\nØ¥Ø¶Ø§ÙØ©ØŸ`)) {
            let link = `${GOOGLE_FORM_URL}?usp=pp_url&entry.${BARCODE_ENTRY_ID}=${code}`;
            openFormModal(link);
        } else {
            startCamera();
        }
    }

    function showResult(p) {
        if(html5QrcodeScanner) html5QrcodeScanner.clear();
        document.getElementById('scan-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        
        document.getElementById('p_name').innerText = p.name;
        document.getElementById('p_cat').innerText = p.category;
        document.getElementById('p_code_local').innerText = p.code1;
        document.getElementById('p_code_global').innerText = p.code2;
        
        if(p.img) document.getElementById('p_img').src = p.img;
        
        let html = `<table class="prices-table">
            <tr><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th></tr>
            <tr><td>Ù‚Ø·Ø¹Ø©</td><td>${p.price1}</td></tr>
            <tr><td>Ø¯Ø³ØªØ©</td><td>${p.price2}</td></tr>
            <tr><td>ÙƒØ±ØªÙˆÙ†Ø©</td><td>${p.price3}</td></tr>
        </table>`;
        document.getElementById('prices-container').innerHTML = html;
    }

    function resetScanner() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('scan-screen').style.display = 'block';
        document.getElementById('search-input').value = "";
        startCamera();
    }

    function startCamera() {
        document.getElementById('reader').innerHTML = "";
        html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, videoConstraints: { facingMode: "environment" } });
        html5QrcodeScanner.render(onScanSuccess);
    }

    fetchProducts().then(() => startCamera());

</script>
</body>
</html>
