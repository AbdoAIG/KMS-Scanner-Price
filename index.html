<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø®Ø²Ù† (Ø§Ù„ØªØ´Ø®ÙŠØµ)</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  :root { --primary-color: #0056b3; --secondary-color: #007bff; --bg-color: #f4f7f6; --text-color: #333; }
  body { font-family: sans-serif; text-align: center; background: var(--bg-color); margin: 0; padding-bottom: 60px; }
  .container { max-width: 600px; margin: 10px auto; background: #fff; padding: 15px; border-radius: 20px; display: flex; flex-direction: column; }
  .app-logo { max-width: 140px; max-height: 80px; margin: 0 auto 10px; display: block; }
  .refresh-btn { background: none; border: 1px solid var(--secondary-color); color: var(--secondary-color); padding: 5px 15px; border-radius: 20px; cursor: pointer; margin-bottom: 10px; }
  .scanner-wrapper { position: relative; width: 100%; height: 280px; margin-bottom: 20px; background: #000; border-radius: 20px; overflow: hidden; }
  #reader { width: 100%; height: 100%; object-fit: cover; }
  .search-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 12px; margin-bottom: 10px; }
  .suggestions-list { position: absolute; background: white; width: 90%; left: 5%; z-index: 1000; border: 1px solid #eee; display: none; }
  .suggestion-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; text-align: right; }
  #result-screen { display: none; text-align: right; background: #fff; padding: 20px; border-radius: 15px; border: 1px solid #eee; }
  .detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
  .detail-label { font-weight: bold; color: var(--primary-color); }
  .prices-table { width: 100%; margin-top: 15px; border-collapse: collapse; }
  .prices-table th { background: var(--secondary-color); color: white; padding: 8px; }
  .prices-table td { border: 1px solid #eee; padding: 8px; text-align: center; }
  .btn { display: block; width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 10px; color: white; cursor: pointer; }
  .btn-primary { background: var(--secondary-color); }
  .btn-warning { background: #ffc107; color: #333; }
  .btn-edit { background: #17a2b8; color: white; }
  .status-msg { padding: 10px; background: #e2f0fb; border-radius: 8px; margin-bottom: 10px; display: none; }
  
  #back-fab { position: fixed; bottom: 20px; left: 20px; width: 55px; height: 55px; background: var(--secondary-color); color: white; border-radius: 50%; border: none; font-size: 24px; z-index: 2000; display: none; }
  .modal { display: none; position: fixed; z-index: 5000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
  .modal-content { margin: 50px auto; width: 90%; max-width: 600px; }
  .close-zoom { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }
  .form-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 4000; }
  .form-iframe { width: 100%; height: 100%; border: none; }
  .close-form-btn { position: absolute; top: 10px; left: 10px; background: red; color: white; padding: 10px; border: none; cursor: pointer; }
</style>
</head>
<body>

<div id="imageModal" class="modal" onclick="closeImageModal()"><span class="close-zoom">&times;</span><img class="modal-content" id="img01"></div>
<div id="formModal" class="form-modal"><button class="close-form-btn" onclick="closeFormModal()">âœ– Ø¥ØºÙ„Ø§Ù‚</button><iframe id="googleFormIframe" class="form-iframe" src=""></iframe></div>
<button id="back-fab" onclick="goBack()">ğŸ”™</button>

<div class="container">
  <div id="scan-screen">
    <img id="company-logo" src="" class="app-logo" alt="Logo" onerror="this.style.display='none'">
    <h3>Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
    <div id="status" class="status-msg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <button class="refresh-btn" onclick="fetchProducts(true)">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    
    <div class="search-wrapper"><input type="text" id="search-input" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="suggestProducts()" autocomplete="off"><div id="suggestions" class="suggestions-list"></div></div>
    <div class="scanner-wrapper"><div id="reader"></div></div>
    <a id="add-btn" class="btn btn-warning">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</a>
  </div>

  <div id="list-screen" style="display:none;">
      <h3 id="category-title"></h3>
      <div id="subcategories-filter" style="display:flex; overflow-x:auto; gap:5px; padding:5px;"></div>
      <div id="list-content"></div>
  </div>

  <div id="result-screen" class="result-box">
    <img id="p_img" src="" class="product-img" style="width:100px; margin:0 auto; display:block;" onclick="openImageModal(this.src)">
    <div class="detail-row"><span class="detail-label">Ø§Ù„Ù…Ù†ØªØ¬:</span><span id="p_name"></span></div>
    <div class="detail-row"><span class="detail-label">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (C):</span><span id="p_code_local" class="barcode-style"></span></div>
    <div class="detail-row"><span class="detail-label">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (D):</span><span id="p_code_global" class="barcode-style"></span></div>
    <div id="prices-container"></div>
    <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn btn-primary" onclick="goBack()" style="flex:1">Ø±Ø¬ÙˆØ¹</button>
        <button class="btn btn-edit" onclick="editCurrentProduct()" style="flex:1">ØªØ¹Ø¯ÙŠÙ„</button>
    </div>
  </div>
</div>

<script>
    // ============================================================
    // ğŸ”´ğŸ”´ Ø¶Ø¹ Ø±ÙˆØ§Ø¨Ø·Ùƒ Ù‡Ù†Ø§ ÙˆØªØ£ÙƒØ¯ Ù…Ù†Ù‡Ø§ ğŸ”´ğŸ”´
    // ============================================================
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKotb6frhhZzBOkKyvUu0V1x06UkENSEkdtSn52yfc7OG030tDMxwjjjEX8tV1UGgpNzMTuObGRur3/pub?gid=167717044&single=true&output=csv"; 
    const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfT5WLBAE4dTq-uprfqbVnX1K8HWrOs8AlyGH60IdEkBee2Kg/viewform?usp=header";
    const LOGO_URL = "Ø¶Ø¹_Ø±Ø§Ø¨Ø·_Ø§Ù„Ø´Ø¹Ø§Ø±_Ù‡Ù†Ø§"; 
    
    const BARCODE_ENTRY_ID = "1811127320"; 
    const NAME_ENTRY_ID = "198039627"; 
    const PRICE1_ENTRY_ID = "1964075675"; 
    // ============================================================

    if(LOGO_URL) document.getElementById('company-logo').src = LOGO_URL;
    
    function openImageModal(src) { document.getElementById("imageModal").style.display = "block"; document.getElementById("img01").src = src; }
    function closeImageModal() { document.getElementById("imageModal").style.display = "none"; }
    function openFormModal(url) { document.getElementById('googleFormIframe').src = url; document.getElementById('formModal').style.display = 'block'; }
    function closeFormModal() { document.getElementById('formModal').style.display = 'none'; document.getElementById('googleFormIframe').src = ""; resetScanner(); }

    var productsList = []; var categoriesSet = new Set(); var html5QrcodeScanner;
    var currentProduct = null; var lastScreen = "scan-screen";

    document.getElementById('add-btn').onclick = function() { openFormModal(GOOGLE_FORM_URL); };

    async function fetchProducts(force = false) {
        document.getElementById('status').style.display = 'block';
        document.getElementById('status').innerText = "ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        if(SHEET_CSV_URL.includes("Ø¶Ø¹_Ø±Ø§Ø¨Ø·")) {
            alert("âš ï¸ Ø®Ø·Ø£: Ù„Ù… ØªÙ‚Ù… Ø¨ÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ (CSV) ÙÙŠ Ø§Ù„ÙƒÙˆØ¯!");
            return;
        }

        let fetchUrl = SHEET_CSV_URL;
        if(force) fetchUrl += "&t=" + new Date().getTime();

        try {
            const response = await fetch(fetchUrl, { cache: "no-store" });
            if (!response.ok) throw new Error("Network error");
            const data = await response.text();
            
            // ğŸ”´ ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ”´
            if(data.length < 50) {
                alert("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ ÙØ§Ø±Øº Ø£Ùˆ ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹! ØªØ£ÙƒØ¯ Ù…Ù† ØµÙØ­Ø© Master.");
            }
            
            localStorage.setItem('offline_products_csv', data);
            parseCSV(data);
            document.getElementById('status').innerText = "âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„: " + productsList.length + " Ù…Ù†ØªØ¬";
            setTimeout(() => { document.getElementById('status').style.display = 'none'; }, 2000);
        } catch (error) {
            // ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ÙƒØ§Ø´
            const cachedData = localStorage.getItem('offline_products_csv');
            if (cachedData) { 
                parseCSV(cachedData); 
                document.getElementById('status').innerText = "âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† (" + productsList.length + " Ù…Ù†ØªØ¬)"; 
                setTimeout(() => { document.getElementById('status').style.display = 'none'; }, 2000);
            } else {
                alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©.\nØ§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„: Ø§Ù„Ø±Ø§Ø¨Ø· Ø®Ø·Ø£ Ø£Ùˆ Ø§Ù„Ù†Øª Ù…ÙØµÙˆÙ„.");
            }
        }
    }

    function sanitizeBarcode(text) {
        if(!text) return "";
        let clean = text; if(clean.includes('.')) clean = clean.split('.')[0];
        return clean.replace(/[^a-zA-Z0-9]/g, '');
    }
    
    function clean(text) { return text ? text.replace(/"/g, '').trim() : ""; }
    function cleanPrice(text) { if(!text) return ""; return text.replace(/"/g, '').replace('Ø¬.Ù…', '').replace('$', '').trim(); }

    function parseCSV(csvText) {
      const rows = csvText.split('\n'); productsList = []; categoriesSet.clear(); let tempMap = new Map();
      for (let i = 1; i < rows.length; i++) {
        if(!rows[i].trim()) continue;
        const row = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        if (row.length >= 11) { 
          const localCode = sanitizeBarcode(row[2]); 
          const globalCode = sanitizeBarcode(row[3]); 
          const name = clean(row[4]); 
          let p1 = cleanPrice(row[5]); let p2 = cleanPrice(row[6]); let p3 = cleanPrice(row[7]); 
          const img = row[8] ? clean(row[8]) : ""; const cat = row[9] ? clean(row[9]) : "Ø¹Ø§Ù…"; const sub = row[10] ? clean(row[10]) : ""; 

          let productData = { code1: localCode, code2: globalCode, name: name, price1: p1, price2: p2, price3: p3, img: img, category: cat, subcategory: sub };
          if(localCode) tempMap.set(localCode, productData);
          if(globalCode) tempMap.set(globalCode, productData);
        }
      }
      productsList = Array.from(tempMap.values());
      productsList = [...new Set(productsList)];
    }

    function findProductInDB(scannedCode) {
        let code = sanitizeBarcode(scannedCode);
        for(let i = productsList.length - 1; i >= 0; i--) {
            let p = productsList[i];
            if(p.code1 === code || p.code2 === code) return p;
            if(p.code1 === code.replace(/^0+/, '')) return p;
            if(p.code2 === code.replace(/^0+/, '')) return p;
        }
        return null;
    }

    function suggestProducts() {
        let inputVal = document.getElementById('search-input').value.toLowerCase().trim();
        let listDiv = document.getElementById('suggestions'); listDiv.innerHTML = ""; 
        if (inputVal.length < 1) { listDiv.style.display = "none"; return; }
        let matchCount = 0; let seenNames = new Set(); 
        for (let i = productsList.length - 1; i >= 0; i--) {
            let p = productsList[i];
            if (p.name.toLowerCase().includes(inputVal) || (p.code1 && p.code1.includes(inputVal)) || (p.code2 && p.code2.includes(inputVal))) {
                if(seenNames.has(p.name)) continue; seenNames.add(p.name);
                let item = document.createElement('div'); item.className = 'suggestion-item';
                item.innerText = p.name + " (" + p.price1 + ")";
                item.onclick = function() { showResultScreen(p, 'scan-screen'); document.getElementById('search-input').value = ""; listDiv.style.display = "none"; };
                listDiv.appendChild(item); matchCount++; if(matchCount >= 10) break;
            }
        }
        listDiv.style.display = (matchCount > 0) ? "block" : "none";
    }

    async function onScanSuccess(decodedText, decodedResult) {
      if(navigator.vibrate) navigator.vibrate(200);
      try { if(html5QrcodeScanner) await html5QrcodeScanner.clear(); } catch(e) {}
      let cleanCode = sanitizeBarcode(decodedText);
      let foundProduct = findProductInDB(cleanCode);
      if (foundProduct) { showResultScreen(foundProduct, 'scan-screen'); } 
      else { 
          if(confirm("ØºÙŠØ± Ù…Ø³Ø¬Ù„: " + cleanCode + "\nØ¥Ø¶Ø§ÙØ©ØŸ")) { 
              let sep = GOOGLE_FORM_URL.includes('?') ? '&' : '?';
              openFormModal(GOOGLE_FORM_URL + sep + "usp=pp_url&entry." + BARCODE_ENTRY_ID + "=" + cleanCode);
          } else { resetScanner(); }
      }
    }

    function showResultScreen(product, source = 'scan-screen') {
        currentProduct = product; lastScreen = source; updateBackButton();
        document.getElementById('scan-screen').style.display = 'none'; document.getElementById('result-screen').style.display = 'block';
        document.getElementById('p_cat').innerText = product.category; document.getElementById('p_name').innerText = product.name; 
        document.getElementById('p_code_local').innerText = product.code1 || "-"; document.getElementById('p_code_global').innerText = product.code2 || "-";
        if(product.img) document.getElementById('p_img').src = product.img;
        
        let priceHTML = `<table class="prices-table"><tr><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th></tr>`;
        if(product.price1) priceHTML += `<tr><td>Ù‚Ø·Ø¹Ø©</td><td class="price-val">${product.price1}</td></tr>`;
        if(product.price2) priceHTML += `<tr><td>Ø¯Ø³ØªØ©</td><td class="price-val">${product.price2}</td></tr>`;
        if(product.price3) priceHTML += `<tr><td>ÙƒØ±ØªÙˆÙ†Ø©</td><td class="price-val">${product.price3}</td></tr>`;
        document.getElementById('prices-container').innerHTML = priceHTML + "</table>";
    }

    function editCurrentProduct() {
        if(!currentProduct) return;
        let code = currentProduct.code2 || currentProduct.code1;
        let sep = GOOGLE_FORM_URL.includes('?') ? '&' : '?';
        let link = GOOGLE_FORM_URL + sep + "usp=pp_url";
        if(BARCODE_ENTRY_ID) link += "&entry." + BARCODE_ENTRY_ID + "=" + code;
        if(NAME_ENTRY_ID) link += "&entry." + NAME_ENTRY_ID + "=" + encodeURIComponent(currentProduct.name);
        if(PRICE1_ENTRY_ID) link += "&entry." + PRICE1_ENTRY_ID + "=" + currentProduct.price1;
        openFormModal(link);
    }

    function goBack() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('scan-screen').style.display = 'block';
        resetScanner();
    }
    function resetScanner() { 
        updateBackButton();
        document.getElementById('reader').innerHTML = "";
        setTimeout(() => {
            html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, videoConstraints: { facingMode: "environment" } });
            html5QrcodeScanner.render(onScanSuccess);
        }, 300);
    }
    function updateBackButton() {
        document.getElementById('back-fab').style.display = document.getElementById('scan-screen').style.display === 'block' ? 'none' : 'flex';
    }
    
    fetchProducts().then(() => resetScanner());
</script>
</body>
</html>
